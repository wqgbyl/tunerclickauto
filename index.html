<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>调音器 + BPM 设定 + 录音/上传分析（AudioWorklet）</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header>
    <h1>调音器 + BPM 设定 + 录音/上传分析</h1>
    <p class="sub">先设定 ♩BPM → 录音进行实时音准显示（录音时不再开启节拍器）→ 结束后回放可叠加节拍器，并生成稳定性分析报告</p>
  </header>

  <main>
    <section class="card">
      <h2>节拍器设置（分析/回放用）</h2>
      <div class="row">
        <label class="bpm">
          ♩ BPM
          <input id="bpmInput" type="number" min="40" max="280" step="1" value="80" />
        </label>
        <label class="slider bpm-slider">
          节拍器速度
          <input id="bpmRange" type="range" min="40" max="280" step="1" value="80" />
          <span id="bpmRangeVal">80</span>
        </label>
      </div>

      <p class="small">说明：节拍器只用于回放/分析阶段，不在实时录制时播放。</p>
    </section>

    <section class="card">
      <h2>节拍器（独立使用）</h2>
      <div class="row">
        <button id="metSoloStart">启动节拍器</button>
        <button id="metSoloStop" disabled>停止节拍器</button>
        <span id="metSoloStatus" class="status">未启动</span>
      </div>
      <div class="row">
        <div class="meter-group">
          <span class="label">拍子模式</span>
          <button class="meter-btn active" data-meter="2">2 拍子</button>
          <button class="meter-btn" data-meter="3">3 拍子</button>
          <button class="meter-btn" data-meter="4">4 拍子</button>
        </div>
        <label class="slider">
          节拍器音量
          <input type="range" id="metSoloGain" min="0" max="1" step="0.01" value="0.35" />
          <span id="metSoloGainVal">0.35</span>
        </label>
      </div>
      <p class="small">可直接启动节拍器练习，拍子模式与音量可随时调整。</p>
    </section>

    <section class="card">
      <h2>录音与实时音准</h2>
      <div class="row">
        <button id="btnStart">开始录音</button>
        <button id="btnStop" disabled>停止</button>
        <span id="status" class="status">未开始</span>
      </div>

      <div class="grid">
        <div class="metric">
          <div class="label">当前音名</div>
          <div class="value" id="noteName">—</div>
        </div>
        <div class="metric">
          <div class="label">频率</div>
          <div class="value" id="freqHz">—</div>
        </div>
        <div class="metric">
          <div class="label">音准偏差</div>
          <div class="value" id="cents">—</div>
        </div>
        <div class="metric">
          <div class="label">设定速度</div>
          <div class="value" id="tempo">♩=—</div>
        </div>
        <div class="metric">
          <div class="label">录音时长</div>
          <div class="value" id="dur">—</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>回放 + 节拍器</h2>
      <div class="row">
        <button id="btnPlay" disabled>回放</button>
        <button id="btnStopPlay" disabled>停止回放</button>
      </div>

      <div class="row">
        <label class="checkbox">
          <input type="checkbox" id="metOn" checked />
          回放时叠加节拍器
        </label>
        <label class="slider">
          回放节拍器音量
          <input type="range" id="metGainPlay" min="0" max="1" step="0.01" value="0.25" />
          <span id="metGainPlayVal">0.25</span>
        </label>
      </div>

      <div class="row tempo-live">
        <span class="label">实时速度</span>
        <span class="value" id="tempoLive">—</span>
      </div>

      <p class="small">回放使用同一条 WebAudio 时间轴（避免手机端 <audio> 与节拍器不同步）。</p>
    </section>

    <section class="card">
      <h2>导出同步视频</h2>
      <div class="row">
        <button id="btnExportVideo" disabled>导出同步视频</button>
        <span id="exportStatus" class="status">未生成</span>
      </div>
      <div id="exportProgressRow" class="row export-progress">
        <progress id="exportProgress" max="100" value="0"></progress>
        <span id="exportPercent" class="status">0%</span>
      </div>
      <div id="exportActions" class="row export-actions">
        <a id="exportLink" class="download" download="metronome-sync.webm">下载视频</a>
        <button id="btnExportPlayAudio" class="secondary" disabled>直接回放音频</button>
      </div>
      <p class="small">导出视频会叠加节拍器声音，并按音乐律动实时标记速度。</p>
    </section>

    <section class="card">
      <h2>上传音频分析</h2>
      <div class="row">
        <input id="uploadAudio" type="file" accept="audio/*" />
        <button id="btnUploadAnalyze">上传并分析</button>
        <span id="uploadStatus" class="status">未选择文件</span>
      </div>
      <p class="small">上传音频后会进行音准统计与节拍稳定性评分，报告与录音共用。</p>
    </section>

    <section class="card">
      <h2>报表（本次录音概要）</h2>
      <div class="report">
        <div class="rrow"><span class="rk">音准综合得分</span><span class="rv" id="repOverallScore">—</span></div>
        <div class="rrow"><span class="rk">主要长音音准得分</span><span class="rv" id="repLongNoteScore">—</span></div>
        <div class="rrow"><span class="rk">节拍速度稳定得分</span><span class="rv" id="repTempoStability">—</span></div>
        <div class="rrow"><span class="rk">主要音高分析</span><span class="rv" id="repTopNotes">—</span></div>
      </div>
    </section>

  </main>

  <footer>
    <span class="small">AudioWorklet 录音分析版 V7</span>
  </footer>

  <script type="module" src="./src/main.js"></script>
</body>
</html>
