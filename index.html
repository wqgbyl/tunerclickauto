<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>调音器 + 录音前设定BPM + 录音中节拍器(声音+闪灯)（AudioWorklet）</title>
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header>
    <h1>调音器 + 录音前设定 BPM + 录音中节拍器（声音+闪灯）</h1>
    <p class="sub">先设定 ♩BPM → 点击录音后节拍器一直响，同时绿灯按“正拍/半拍”闪烁 → 结束后可回放（可选叠加节拍器）</p>
  </header>

  <main>
    <section class="card">
      <h2>节拍器设置（录音前）</h2>
      <div class="row">
        <label class="bpm">
          ♩ BPM
          <input id="bpmInput" type="number" min="30" max="240" step="1" value="90" />
        </label>
        <label class="checkbox">
          <input type="checkbox" id="metDuringRec" checked />
          录音中开启节拍器
        </label>
        <label class="slider">
          录音中节拍器音量
          <input type="range" id="metGainRec" min="0" max="1" step="0.01" value="0.25" />
          <span id="metGainRecVal">0.25</span>
        </label>
      </div>

      <div class="row">
        <div class="ledWrap">
          <div id="ledBeat" class="led"></div>
          <div class="small">绿灯：正拍亮；半拍弱闪</div>
        </div>
      </div>

      <p class="small">说明：录音时节拍器通过 WebAudio 播放给你听；录音文件本身不会“直接混入”节拍器（除非麦克风拾音到外放）。</p>
    </section>

    <section class="card">
      <h2>录音与实时音准</h2>
      <div class="row">
        <button id="btnStart">开始录音</button>
        <button id="btnStop" disabled>停止</button>
        <span id="status" class="status">未开始</span>
      </div>

      <div class="grid">
        <div class="metric">
          <div class="label">当前音名</div>
          <div class="value" id="noteName">—</div>
        </div>
        <div class="metric">
          <div class="label">频率</div>
          <div class="value" id="freqHz">—</div>
        </div>
        <div class="metric">
          <div class="label">音准偏差</div>
          <div class="value" id="cents">—</div>
        </div>
        <div class="metric">
          <div class="label">设定速度</div>
          <div class="value" id="tempo">♩=—</div>
        </div>
        <div class="metric">
          <div class="label">录音时长</div>
          <div class="value" id="dur">—</div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>回放 + 节拍器</h2>
      <div class="row">
        <button id="btnPlay" disabled>回放</button>
        <button id="btnStopPlay" disabled>停止回放</button>
      </div>

      <div class="row">
        <label class="checkbox">
          <input type="checkbox" id="metOn" checked />
          回放时叠加节拍器
        </label>
        <label class="slider">
          回放节拍器音量
          <input type="range" id="metGainPlay" min="0" max="1" step="0.01" value="0.25" />
          <span id="metGainPlayVal">0.25</span>
        </label>
      </div>

      <p class="small">回放使用同一条 WebAudio 时间轴（避免手机端 <audio> 与节拍器不同步）。</p>
    </section>

    <section class="card">
      <h2>报表（本次录音概要）</h2>
      <div class="report">
        <div class="rrow"><span class="rk">平均|cents|</span><span class="rv" id="repMeanAbs">—</span></div>
        <div class="rrow"><span class="rk">10 cents 内比例</span><span class="rv" id="repIn10">—</span></div>
        <div class="rrow"><span class="rk">25 cents 内比例</span><span class="rv" id="repIn25">—</span></div>
        <div class="rrow"><span class="rk">样本数</span><span class="rv" id="repN">—</span></div>
        <div class="rrow"><span class="rk">常见音高(Top5)</span><span class="rv" id="repTop">—</span></div>
      </div>
    </section>

    <section class="card">
      <h2>如何运行</h2>
      <ol>
        <li>本地：在项目目录运行 <code>npx http-server -p 5173</code>，然后打开 <code>http://localhost:5173</code></li>
        <li>手机：建议用 GitHub Pages（HTTPS）访问，确保 AudioWorklet 可用。</li>
      </ol>
    </section>
  </main>

  <footer>
    <span class="small">AudioWorklet 录音中节拍器版 V6</span>
  </footer>

  <script type="module" src="./src/main.js"></script>
</body>
</html>
